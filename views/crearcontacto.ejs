<!doctype html>
<html lang="es">

<head>
    <title>Crear Nuevo Contacto</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
</head>


<body class="container mt-3">

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a href="/" class="nav-link">DIRECTORIO</a>
        </li>
        <li class="nav-item">
            <a href="/crear" class="nav-link active" aria-current="page">CREAR CONTACTO</a>
        </li>
    </ul>

    <br><br>

    <h1>Crear Nuevo Contacto</h1>
    <p>Rellena los campos obligatorios (*) para guardar un nuevo contacto.</p>

    <form class="row g-3" id="formulario_crear">
        <div class="col-md-3">
            <label for="primer_nombre" class="form-label">Primer Nombre (*)</label>
            <input type="text" class="form-control" id="primer_nombre" name="primer_nombre" required>
        </div>
        <div class="col-md-3">
            <label for="segundo_nombre" class="form-label">Segundo Nombre</label>
            <input type="text" class="form-control" id="segundo_nombre" name="segundo_nombre">
        </div>
        <div class="col-md-3">
            <label for="primer_apellido" class="form-label">Primer Apellido (*)</label>
            <input type="text" class="form-control" id="primer_apellido" name="primer_apellido" required>
        </div>
        <div class="col-md-3">
            <label for="segundo_apellido" class="form-label">Segundo Apellido</label>
            <input type="text" class="form-control" id="segundo_apellido" name="segundo_apellido">
        </div>
        <div class="col-md-4">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email">
        </div>
        <div class="col-md-4">
            <label for="telefono" class="form-label">Teléfono</label>
            <input type="tel" class="form-control" id="telefono" name="telefono">
        </div>
        <div class="col-md-4">
            <label for="id_genero" class="form-label">Género</label>
            <select id="id_genero" name="id_genero" class="form-select">
                <option value="">Seleccionar...</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="id_direccion" class="form-label">Dirección</label>
            <select id="id_direccion" name="id_direccion" class="form-select">
                <option value="">Seleccionar...</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="id_tipo_telefono" class="form-label">Tipo de Teléfono</label>
            <select id="id_tipo_telefono" name="id_tipo_telefono" class="form-select">
                <option value="">Seleccionar...</option>
            </select>
        </div>
        <div class="col-12">
            <label for="imagen" class="form-label">Ruta de Imagen (URL)</label>
            <input type="text" class="form-control" id="imagen" name="imagen" placeholder="http://ejemplo.com/foto.png">
        </div>
        
        <div class="col-12">
            <div id="mensaje" class="mt-3"></div>
        </div>

        <div class="col-12 mt-4">
            <button type="submit" class="btn btn-primary">Guardar Contacto</button>
            <a href="/" class="btn btn-secondary">Cancelar</a> 
        </div>
    </form>

    <br><br>

    <script>
        // Función para cargar los selects (NO CAMBIA)
        function cargarSelect(urlApi, selectElementId, valor, texto) {
            const select = document.getElementById(selectElementId);
            fetch(urlApi)
                .then(res => res.json())
                .then(data => {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valor];
                        option.textContent = item[texto];
                        select.appendChild(option);
                    });
                })
                .catch(err => console.error(`Error cargando ${selectElementId}:`, err));
        }

        // ✅ FUNCIÓN MODIFICADA CON SWEETALERT
        function manejarEnvio(event) {
            event.preventDefault(); 
            const formulario = event.target;
            
            // Ya no necesitamos el div 'mensaje', así que quitamos esas líneas
            const formData = new FormData(formulario);
            const datos = Object.fromEntries(formData.entries());

            fetch('/api/contactos', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => { throw new Error(err.error || 'Error desconocido'); });
                }
                return res.json();
            })
            .then(respuesta => {
                // ✅ AQUI USAMOS SWEETALERT DE ÉXITO
                Swal.fire({
                    title: '¡Excelente!',
                    text: 'Contacto guardado exitosamente',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // Esto se ejecuta cuando termina el timer
                    window.location.href = '/'; 
                });

                formulario.reset();
            })
            .catch(err => {
                // ❌ AQUI USAMOS SWEETALERT DE ERROR
                Swal.fire({
                    title: 'Oops...',
                    text: err.message, // "Error al guardar: ..."
                    icon: 'error',
                    confirmButtonText: 'Intentar de nuevo'
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            cargarSelect('/api/generos', 'id_genero', 'id_genero', 'detalle_genero');
            cargarSelect('/api/direcciones', 'id_direccion', 'id_direccion', 'detalle_direccion');
            cargarSelect('/api/tipos-telefono', 'id_tipo_telefono', 'id_tipo_telefono', 'detalle_tipo_telefono');

            const formulario = document.getElementById('formulario_crear');
            formulario.addEventListener('submit', manejarEnvio);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
</body>

</html>